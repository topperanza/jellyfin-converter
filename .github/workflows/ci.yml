name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Show Bash version
        run: bash --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install ShellCheck
        env:
          PIP_INDEX_URL: ${{ secrets.PIP_INDEX_URL }}
          PIP_EXTRA_INDEX_URL: ${{ secrets.PIP_EXTRA_INDEX_URL }}
        run: |
          ./scripts/install_shellcheck.sh

      - name: Verify ShellCheck
        run: shellcheck --version

      - name: Install ffmpeg
        uses: federico-busato/setup-ffmpeg@v2
        with:
          ffmpeg-version: release

      - name: Verify ffmpeg
        run: |
          ffmpeg -version
          ffprobe -version

      - name: Bash Syntax Check
        run: |
          find . -type f -name "*.sh" -print0 | xargs -0 bash -n

      - name: Run ShellCheck
        run: |
          find . -type f -name "*.sh" \
            -not -path "./.git/*" \
            -not -path "./.venv/*" \
            -print0 | xargs -0 shellcheck -x -S error

      - name: Run Tests
        run: |
          if [ -x "./tests/run.sh" ]; then
            if command -v ffprobe >/dev/null 2>&1; then
              ./tests/run.sh "tests/suite_*.sh tests/test_*.sh"
            else
              files=$(ls tests/suite_*.sh tests/test_*.sh 2>/dev/null || true)
              filtered=""
              skip_files="tests/test_subtitles_fix.sh"
              for f in tests/suite_*.sh tests/test_*.sh; do
                [ -f "$f" ] || continue
                if ! grep -qi ffprobe "$f"; then
                  skip=0
                  for s in $skip_files; do
                    if [ "$f" = "$s" ]; then skip=1; break; fi
                  done
                  if [ "$skip" -eq 0 ]; then
                    filtered="$filtered $f"
                  fi
                fi
              done
              if [ -n "$filtered" ]; then
                $TEST_SHELL ./tests/run.sh "$filtered"
              else
                echo "No ffprobe-independent tests found; skipping."
              fi
            fi
          elif [ -f "./tests/run.sh" ]; then
            $TEST_SHELL ./tests/run.sh "tests/suite_*.sh tests/test_*.sh"
          else
            echo "No test runner found."
          fi
